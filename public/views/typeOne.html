


<div>
		
			 <div id="map-canvas1" style="width: 100%;height: 900px;"></div>
</div>
<!-- <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing,places,geometry"></script>
  <script src="fabric.all.min.js" ></script> -->


<script type="text/javascript">

  var canvas;
  var canobjseled = false;

  var loc_center = new google.maps.LatLng(40.743388, -74.007592);
     var k_diff = 0.005;
    var D_diff = 0.01;
    var rot = 0;
    var overlay;
    var size_marker;
    var map;
    var rotation_marker ;
function createCanvas() {

    canvas = new fabric.Canvas('map-can');

    // we need this here because this is when the canvas gets initialized
    ['object:moving', 'object:scaling'].forEach(addChildMoveLine);
    fabric.Object.prototype.transparentCorners = false;

var loadjsn='{"objects":[{"type":"image","originX":"left","originY":"top","left":91.86,"top":183.25,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.47,"scaleY":0.21,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/turbine.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":168.6,"top":12.38,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.11,"scaleY":0.1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/1.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":291.2,"top":0.46,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.25,"scaleY":0.25,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/2.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":457.64,"top":3.44,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.25,"scaleY":0.25,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/3.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":2.16,"top":41.19,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.16,"scaleY":0.17,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/4.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":79.9,"top":50.13,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.14,"scaleY":0.13,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/5.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":163.62,"top":112.72,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.14,"scaleY":0.12,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/6.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":253.32,"top":130.6,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.14,"scaleY":0.12,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/7.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":338.04,"top":108.28,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.15,"scaleY":0.12,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/8.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"},{"type":"image","originX":"left","originY":"top","left":355.98,"top":168.34,"width":500,"height":500,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.44,"scaleY":0.25,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"images/turbine.png","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"}],"background":""}';


 
canvas.loadFromJSON(loadjsn, canvas.renderAll.bind(canvas), function(o, object) {
    fabric.log(o, object);
});
canvas.on('object:selected', function(){ 
  canobjseled = true;
});

canvas.on('selection:cleared', function(){ 
  canobjseled = false;
});
}



  window.newAnimation = function () {
     console.log(JSON.stringify(canvas.toJSON()));
}


function addChildLine(options) {
    canvas.off('object:selected', addChildLine);

    // add the line
    var fromObject = canvas.addChild.start;
    var toObject = options.target;
    var from = fromObject.getCenterPoint();
    var to = toObject.getCenterPoint();
    var line = new fabric.Line([from.x, from.y, to.x, to.y], {
        fill: 'red',
        stroke: 'red',
        strokeWidth: 5,
        selectable: false
    });
    canvas.add(line);
    // so that the line is behind the connected shapes
    line.sendToBack();

    // add a reference to the line to each object
    fromObject.addChild = {
        // this retains the existing arrays (if there were any)
        from: (fromObject.addChild && fromObject.addChild.from) || [],
        to: (fromObject.addChild && fromObject.addChild.to)
    }
    fromObject.addChild.from.push(line);
    toObject.addChild = {
        from: (toObject.addChild && toObject.addChild.from),
        to: (toObject.addChild && toObject.addChild.to) || []
    }
    toObject.addChild.to.push(line);

    // to remove line references when the line gets removed
    line.addChildRemove = function () {
        fromObject.addChild.from.forEach(function (e, i, arr) {
            if (e === line)
                arr.splice(i, 1);
        });
        toObject.addChild.to.forEach(function (e, i, arr) {
            if (e === line)
                arr.splice(i, 1);
        });
    }

    // undefined instead of delete since we are anyway going to do this many times
    canvas.addChild = undefined;
}

function addChildMoveLine(event) {
    canvas.on(event, function (options) {
        var object = options.target;
        var objectCenter = object.getCenterPoint();
        // udpate lines (if any)
        if (object.addChild) {
            if (object.addChild.from)
                object.addChild.from.forEach(function (line) {
                    line.set({ 'x1': objectCenter.x, 'y1': objectCenter.y });
                })
                if (object.addChild.to)
                    object.addChild.to.forEach(function (line) {
                        line.set({ 'x2': objectCenter.x, 'y2': objectCenter.y });
                    })
                    }

        canvas.renderAll();
    });
}

window.addChild = function () {
    canvas.addChild = {
        start: canvas.getActiveObject()
    }

    // for when addChild is clicked twice
    canvas.off('object:selected', addChildLine);
    canvas.on('object:selected', addChildLine);
}

window.deleteObject = function () {
    var object = canvas.getActiveObject();

    // remove lines (if any)
    if (object.addChild) {
        if (object.addChild.from)
            // step backwards since we are deleting
            for (var i = object.addChild.from.length - 1; i >= 0; i--) {
                var line = object.addChild.from[i];
                line.addChildRemove();
                line.remove();
            }
        if (object.addChild.to)
            for (var i = object.addChild.to.length - 1; i >= 0; i--) {
                var line = object.addChild.to[i];
                line.addChildRemove();
                line.remove();
            }
    }

    object.remove();
}
  function initialize() {
  var mapOptions = {
    zoom: 15,
    center: loc_center
  };

  map = new google.maps.Map(document.getElementById('map-canvas1'), mapOptions);
           var swBound = new google.maps.LatLng(loc_center.lat() - k_diff, loc_center.lng() - D_diff);
            var neBound = new google.maps.LatLng(loc_center.lat() + k_diff, loc_center.lng() + D_diff);
            var bounds = new google.maps.LatLngBounds(swBound, neBound);

  overlay = new DraggableOverlay(map,
    map.getCenter(),
    '<button onClick="newAnimation()">save</button><button onClick="addChild()">Add Child</button><button onClick="deleteObject()">Delete Object</button><canvas  id="map-can" ></canvas>',bounds
  );


//Size marker
            var ext_svg = {
            path: 'M -35 -35 h 70 v 70 h -70 Z',
            fillOpacity: 0.5,
            fillOpacity: 0,
            strokeWeight: 10,
            scale: 0.2
         };
           size_marker = new google.maps.Marker({
            position: new google.maps.LatLng(overlay.position.lat() +k_diff, overlay.position.lng() + D_diff),
            map: map,
            draggable: true,
            icon: ext_svg
          });
 google.maps.event.addListener(size_marker,'drag',function(){
                k_diff = (size_marker.getPosition().lat() - overlay.position.lat());
            D_diff = (size_marker.getPosition().lng() - overlay.position.lng());
console.log(k_diff+"--"+D_diff);
              var newPointA = new google.maps.LatLng(overlay.position.lat() - k_diff, overlay.position.lng() - D_diff);
              var newPointB = new google.maps.LatLng(overlay.position.lat() + k_diff, overlay.position.lng() + D_diff);
              var newBounds = new google.maps.LatLngBounds(newPointA, newPointB);

                overlay.updateBounds(newBounds);
               
            });
			
			google.maps.event.addListener(map, 'click', function (event) {
 var position = event.latLng;
 var neBound = new google.maps.LatLng(position.lat() , position.lng());
              displayCoordinates(event.latLng,neBound);  
				//console.log(event.latLng);
          });
			
			
			
			
			
			
			
			
			
			
            google.maps.event.addListener(size_marker, 'dragend', function () {
              var newPointA = new google.maps.LatLng(overlay.position.lat() + k_diff, overlay.position.lng());
                   
                 
              rotation_marker.setPosition(newPointA);
             
            });

            /*google.maps.event.addListener(map, 'mousemove', function (event) {
              displayCoordinates(event.latLng);               
          });*/

              //Rotation marker
            var circle_svg = {
            path: 'M 0, 0 m -75, 0 a 75,75 0 1,0 150,0 a 75,75 0 1,0 -150,0',
            fillOpacity: 0.5,
            fillOpacity: 0,
            strokeWeight: 2,
            scale: 0.1
          };
             rotation_marker = new google.maps.Marker({
            position: new google.maps.LatLng(loc_center.lat() + k_diff, loc_center.lng()),
            map: map,
            draggable: true,
            icon: circle_svg
          });
            google.maps.event.addListener(rotation_marker,'drag',function() {
              k_rotation_diff = rotation_marker.getPosition().lat() - overlay.position.lat();
              D_rotation_diff = rotation_marker.getPosition().lng() - overlay.position.lng();
          rot = Math.atan2(D_rotation_diff, k_rotation_diff) * 180 / Math.PI;
          overlay.updateRotation();
           
            });

}



DraggableOverlay.prototype = new google.maps.OverlayView();
DraggableOverlay.prototype.onAdd = function() {
  var container = document.createElement('div'),
    that = this;

  if (typeof this.get('content').nodeName !== 'undefined') {
    container.appendChild(this.get('content'));
  } else {
    if (typeof this.get('content') === 'string') {
      container.innerHTML = this.get('content');
    } else {
      return;
    }
  }
  container.style.position = 'absolute';
   container.style.background = 'black';
   container.style.opacity = '0.6'
    container.style.width = '662px';
    container.style.height = '325px';
  container.draggable = true;
  google.maps.event.addDomListener(this.get('map').getDiv(),
    'mouseleave',
    function() {
      google.maps.event.trigger(container, 'mouseup');
    }
  );

  google.maps.event.addDomListener(container,
    'mousedown',
    function(e) {
      
       that.map.set('draggable', false);
      that.set('origin', e);

      if(!canobjseled){
      this.style.cursor = 'move';
     

      that.moveHandler = google.maps.event.addDomListener(that.get('map').getDiv(),
        'mousemove',
        function(e) {
          var origin = that.get('origin'),
            left = origin.clientX - e.clientX,
            top = origin.clientY - e.clientY,
            pos = that.getProjection()
            .fromLatLngToDivPixel(that.get('position')),
            latLng = that.getProjection()
            .fromDivPixelToLatLng(new google.maps.Point(pos.x - left,
              pos.y - top));
          that.set('origin', e);
          that.set('position', latLng);
          that.draw();
            var newPointA = new google.maps.LatLng(latLng.lat() - k_diff, latLng.lng() - D_diff);
              var newPointB = new google.maps.LatLng(latLng.lat() + k_diff, latLng.lng() + D_diff);
              
              var newBounds = new google.maps.LatLngBounds(newPointA, newPointB);

              var newPointR = new google.maps.LatLng(overlay.position.lat() + (Math.cos(rot * Math.PI / 180) * 0.005), overlay.position.lng() + (Math.sin(rot * Math.PI / 180) * 0.005));             
              size_marker.setPosition(newPointB);         
              rotation_marker.setPosition(newPointR);

                overlay.updateBounds(newBounds);
        });
    }
  }
  );
  google.maps.event.addDomListener(container, 'mouseup', function() {
    that.map.set('draggable', true);
    this.style.cursor = 'default';
    google.maps.event.removeListener(that.moveHandler);
  });
  this.set('container', container)
  this.getPanes().floatPane.appendChild(container);
  createCanvas();
};

function DraggableOverlay(map, position, content,bounds) {
  if (typeof draw === 'function') {
    this.draw = draw;
  }
  this.setValues({
    position: position,
    container: null,
    content: content,
    map: map,
    bounds:bounds
  });

};



 DraggableOverlay.prototype.draw = function() {
          var overlayProjection = this.getProjection();
          var sw = overlayProjection.fromLatLngToDivPixel(this.bounds.getSouthWest());
          var ne = overlayProjection.fromLatLngToDivPixel(this.bounds.getNorthEast());
          var div = this.get('container');
          div.style.left = sw.x + 'px';
          div.style.top = ne.y + 'px';
          div.style.width = (ne.x - sw.x) + 'px';
          div.style.height = (sw.y - ne.y) + 'px';
          div.style.transform = 'rotate(' + rot + 'deg)';


        /*   var scaleMultiplier = (ne.x - sw.x)  / canvas.width;
           var objects = canvas.getObjects();
            for (var i in objects) {
                objects[i].scaleX = objects[i].scaleX * scaleMultiplier;
                objects[i].scaleY = objects[i].scaleY * scaleMultiplier;
                objects[i].left = objects[i].left * scaleMultiplier;
                objects[i].top = objects[i].top * scaleMultiplier;
                 objects[i].right = objects[i].right * scaleMultiplier;

                objects[i].setCoords();
            }  */

            canvas.setWidth(ne.x - sw.x);
            canvas.setHeight(sw.y - ne.y-20 );
            canvas.renderAll();
            canvas.calcOffset();
        };

DraggableOverlay.prototype.onRemove = function() {
  this.get('container').parentNode.removeChild(this.get('container'));
  this.set('container', null)
};

 DraggableOverlay.prototype.updateBounds = function(bounds){
          this.bounds= bounds;
          this.draw();
        };
   DraggableOverlay.prototype.updateRotation = function(){
          this.draw();
        };


//google.maps.event.addDomListener(window, 'load', initialize);

function displayCoordinates(pnt,neBound) {

          var lat = pnt.lat();
          lat = lat.toFixed(4);
          var lng = pnt.lng();
          lng = lng.toFixed(4);
          console.log("Latitude: " + lat + "  Longitude: " + lng);
		  showNewRect(lat,lng,neBound);
      }
 var infoWindow = new google.maps.InfoWindow();
		   function showNewRect(lat,lng,neBound) {
        <!-- var ne = .getBounds().getNorthEast(); -->
        <!-- var sw = .getBounds().getSouthWest(); -->

        var contentString = '<b>Object selected at.</b><br>' +
            '"Latitude: "' + lat + '"  Longitude: "' + lng;

        // Set the info window's content and position.
        infoWindow.setContent(contentString);
        infoWindow.setPosition(neBound);

        infoWindow.open(map);
      }
/*function displayCoordinates(pnt) {

          var lat = pnt.lat();
          lat = lat.toFixed(4);
          var lng = pnt.lng();
          lng = lng.toFixed(4);
          console.log("Latitude: " + lat + "  Longitude: " + lng);
      }*/
$(document).ready(function(){

initialize();
});
//google.maps.event.addDomListener(window, 'load', initialize);
</script>